<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Payments</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #3498db;
    --secondary: #2980b9;
    --success: #27ae60;
    --danger: #e74c3c;
    --warning: #f39c12;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --gray: #7f8c8d;
    --border: #bdc3c7;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --radius: 8px;
    --transition: all 0.3s ease;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .header h2 {
    color: var(--primary);
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 28px;
  }

  .controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    flex-wrap: wrap;
    gap: 15px;
  }

  .search-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .search-container label {
    font-weight: 600;
    color: var(--dark);
  }

  .search-container input {
    padding: 10px 15px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 16px;
    transition: var(--transition);
    width: 200px;
  }

  .search-container input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  }

  .btn {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn:hover {
    background: var(--secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .btn-success {
    background: var(--success);
  }

  .btn-success:hover {
    background: #219653;
  }

  .btn-danger {
    background: var(--danger);
  }

  .btn-danger:hover {
    background: #c0392b;
  }

  .btn-warning {
    background: var(--warning);
  }

  .btn-warning:hover {
    background: #e67e22;
  }

  .bookings-container {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 30px;
  }

  .bookings-header {
    background: var(--primary);
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .bookings-content {
    padding: 20px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--dark);
    position: sticky;
    top: 0;
  }

  tr:hover {
    background: #f8f9fa;
  }

  .voided-row {
    background-color: #ffebee;
  }

  .status-badge {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-active {
    background: #e8f5e8;
    color: #2e7d32;
  }

  .status-voided {
    background: #ffebee;
    color: #c62828;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: var(--radius);
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .btn-edit {
    background: var(--primary);
    color: white;
  }

  .btn-edit:hover {
    background: var(--secondary);
  }

  .btn-delete {
    background: var(--danger);
    color: white;
  }

  .btn-delete:hover {
    background: #c0392b;
  }

  .btn-void {
    background: var(--warning);
    color: white;
  }

  .btn-void:hover {
    background: #e67e22;
  }

  .loading {
    text-align: center;
    padding: 30px;
    color: var(--gray);
  }

  .loading i {
    font-size: 36px;
    margin-bottom: 15px;
    color: var(--primary);
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--gray);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #dfe6e9;
  }

  .empty-state p {
    font-size: 18px;
  }

  @media (max-width: 768px) {
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search-container {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search-container input {
      width: 100%;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    table {
      font-size: 12px;
    }
    
    th, td {
      padding: 8px 10px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2><i class="fas fa-calendar-alt"></i> Manage Bookings</h2>
    <p>View, edit, and manage all bookings</p>
  </div>

  <div class="controls">
    <div class="search-container">
      <label for="searchReceipt"><i class="fas fa-search"></i> Search by Receipt No:</label>
      <input type="number" id="searchReceipt" placeholder="Enter Receipt No">
      <button id="searchBtn" class="btn">
        <i class="fas fa-search"></i> Search
      </button>
    </div>
    <button id="loadAllBtn" class="btn btn-success">
      <i class="fas fa-sync-alt"></i> Load All Bookings
    </button>
  </div>

  <div class="bookings-container">
    <div class="bookings-header">
      <i class="fas fa-list"></i>
      <span>Bookings List</span>
    </div>
    <div class="bookings-content">
      <div id="bookingsDiv">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading bookings...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire2.js"></script>

<script>
const bookingsDiv = document.getElementById("bookingsDiv");
const searchReceipt = document.getElementById("searchReceipt");
const searchBtn = document.getElementById("searchBtn");
const loadAllBtn = document.getElementById("loadAllBtn");

// Fetch and display bookings
async function loadBookings(query = null) {
  bookingsDiv.innerHTML = `
    <div class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading receipts...</p>
    </div>
  `;
  
  let snapshot;
  try {
    if(query){
      snapshot = await db.collection("payments")
                         .where("receiptNo", "==", parseInt(query))
                         .get();
    } else {
      snapshot = await db.collection("payments")
                         .orderBy("timestamp", "desc")
                         .get();
    }

    if(snapshot.empty){
      bookingsDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-receipt"></i>
          <p>No bookings found.</p>
        </div>
      `;
      return;
    }

    let html = `<table>
      <thead>
        <tr>
          <th>Receipt No</th>
          <th>Date</th>
          <th>Name</th>
          <th>Flight</th>
          <th>Seat</th>
          <th>Adults</th>
          <th>Kids</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>`;

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const voidedClass = data.voided ? "voided-row" : "";
      const statusClass = data.voided ? "status-voided" : "status-active";
      const statusText = data.voided ? "VOID" : "Active";
      
      html += `
      <tr class="${voidedClass}">
        <td>${data.receiptNo}</td>
        <td>${data.date || '-'}</td>
        <td>${data.name || '-'}</td>
        <td>${data.flight || '-'}</td>
        <td>${data.seat || '-'}</td>
        <td>${data.adults || '0'}</td>
        <td>${data.kids || '0'}</td>
        <td>${data.total ? data.total.toFixed(2) : '0.00'} ${data.currency || ''}</td>
        <td>${data.paymentType || '-'}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td>
          <div class="action-buttons">
            <button onclick="editBooking('${doc.id}')" class="action-btn btn-edit">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteBooking('${doc.id}')" class="action-btn btn-delete">
              <i class="fas fa-trash"></i> Delete
            </button>
            ${!data.voided ? `
            <button onclick="voidBooking('${doc.id}')" class="action-btn btn-void">
              <i class="fas fa-ban"></i> Void
            </button>
            ` : ''}
          </div>
        </td>
      </tr>`;
    });

    html += `</tbody></table>`;
    bookingsDiv.innerHTML = html;
  } catch(err){
    console.error(err);
    bookingsDiv.innerHTML = `
      <div style="color: #e74c3c; text-align: center; padding: 20px;">
        <i class="fas fa-exclamation-circle"></i>
        <p>Error loading receipts: ${err.message}</p>
      </div>
    `;
  }
}

// Edit booking
async function editBooking(docId){
  const docRef = db.collection("payments").doc(docId);
  const docSnap = await docRef.get();
  if(!docSnap.exists){ 
    alert("Receipt not found!"); 
    return; 
  }
  const data = docSnap.data();

  const newName = prompt("Name:", data.name || '');
  if(newName === null) return;
  
  const newFlight = prompt("Flight:", data.flight || '');
  if(newFlight === null) return;
  
  const newSeat = prompt("Seat:", data.seat || '');
  if(newSeat === null) return;
  
  const newAdults = prompt("Adults:", data.adults || '0');
  if(newAdults === null) return;
  
  const newKids = prompt("Kids:", data.kids || '0');
  if(newKids === null) return;
  
  const newPayment = prompt("Payment Type (Cash/Card):", data.paymentType || '');
  if(newPayment === null) return;

  try{
    await docRef.update({
      name: newName,
      flight: newFlight,
      seat: newSeat,
      adults: parseInt(newAdults),
      kids: parseInt(newKids),
      paymentType: newPayment
    });
    alert("Receipt updated successfully!");
    loadBookings();
  } catch(err){
    alert("Error updating receipt: " + err.message);
  }
}

// Delete booking
async function deleteBooking(docId){
  if(!confirm("Are you sure you want to delete this booking? This action cannot be undone.")) return;
  try{
    await db.collection("payments").doc(docId).delete();
    alert("Receipt deleted successfully!");
    loadBookings();
  } catch(err){
    alert("Error deleting receipt: " + err.message);
  }
}

// Void booking
async function voidBooking(docId){
  const reason = prompt("Enter reason for voiding this receipt:");
  if(!reason) return;
  try{
    await db.collection("payments").doc(docId).update({
      voided: true,
      voidReason: reason
    });
    alert("Receipt voided successfully!");
    loadBookings();
  } catch(err){
    alert("Error voiding receipt: " + err.message);
  }
}

// Event listeners
searchBtn.addEventListener("click", () => {
  if (searchReceipt.value) {
    loadBookings(searchReceipt.value);
  } else {
    alert("Please enter a receipt number to search");
  }
});

loadAllBtn.addEventListener("click", () => {
  searchReceipt.value = "";
  loadBookings();
});

// Load all bookings on page load
window.addEventListener("DOMContentLoaded", () => loadBookings());
</script>
</body>
</html>
