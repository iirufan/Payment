<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shift Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire2.js"></script> <!-- Firebase config -->
<script src="users.js"></script> <!-- Users array -->
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; }
.container { max-width: 900px; margin: 0 auto; }
.header { text-align: center; margin-bottom: 20px; }
.header h1 { color: #4361ee; }
.shift-info { text-align: center; margin-bottom: 20px; font-size: 18px; }
.buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; color: white; }
#openShiftBtn { background: #28a745; }
#closeShiftBtn { background: #dc3545; }
#openShiftBtn:disabled, #closeShiftBtn:disabled { background: #888; cursor: not-allowed; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; }
th { background: #f8f9fa; }
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>Shift Management</h1></div>
  <div class="shift-info" id="currentShiftInfo">Loading current shift...</div>
  <div class="buttons">
    <button id="openShiftBtn">Open Shift</button>
    <button id="closeShiftBtn">Close Shift</button>
  </div>
  <table id="shiftsTable">
    <thead>
      <tr>
        <th>Shift No</th>
        <th>Status</th>
        <th>User</th>
        <th>Start Time</th>
        <th>End Time</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5" style="text-align:center;">Loading shifts...</td></tr>
    </tbody>
  </table>
</div>

<script>
window.addEventListener('load', async () => {
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const currentShiftInfo = document.getElementById("currentShiftInfo");
  const openBtn = document.getElementById("openShiftBtn");
  const closeBtn = document.getElementById("closeShiftBtn");
  const shiftsTableBody = document.querySelector("#shiftsTable tbody");

  const today = new Date().toISOString().split("T")[0];
  const currentUser = "Leeli"; // replace with your login logic
  let currentShift = null;

  async function loadShifts() {
    const snapshot = await db.collection("shifts")
      .where("date", "==", today)
      .orderBy("shiftNo")
      .get();

    const shifts = [];
    snapshot.forEach(doc => shifts.push({ id: doc.id, ...doc.data() }));

    renderShifts(shifts);
    currentShift = shifts.find(s => s.status === "open") || null;
    updateShiftInfo(shifts);
  }

  function renderShifts(shifts) {
    if (!shifts.length) {
      shiftsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No shifts today</td></tr>`;
      return;
    }
    shiftsTableBody.innerHTML = "";
    shifts.forEach(s => {
      const start = s.startTime ? new Date(s.startTime.seconds*1000).toLocaleString() : "-";
      const end = s.endTime ? new Date(s.endTime.seconds*1000).toLocaleString() : "-";
      shiftsTableBody.innerHTML += `<tr>
        <td>${s.shiftNo}</td>
        <td>${s.status}</td>
        <td>${s.user}</td>
        <td>${start}</td>
        <td>${end}</td>
      </tr>`;
    });
  }

  function updateShiftInfo(shifts) {
    const shift1 = shifts.find(s => s.shiftNo===1);
    const shift2 = shifts.find(s => s.shiftNo===2);

    if (currentShift) {
      currentShiftInfo.textContent = `Current Shift: ${currentShift.shiftNo} | Status: ${currentShift.status} | User: ${currentShift.user}`;
      openBtn.disabled = true;
      closeBtn.disabled = false;
    } else {
      currentShiftInfo.textContent = "No shift is currently open.";
      closeBtn.disabled = true;
      openBtn.disabled = !( (!shift1) || (shift1.status==='closed' && !shift2) );
    }
  }

  async function requireSupervisor() {
    const pwd = prompt("Supervisor password required:");
    const supervisor = users.find(u => u.Level === "Supervisor");
    if (!supervisor || pwd !== supervisor.password) {
      alert("Invalid supervisor password."); return false;
    }
    return true;
  }

  openBtn.addEventListener("click", async () => {
    const snapshot = await db.collection("shifts").where("date","==",today).orderBy("shiftNo").get();
    const shifts = [];
    snapshot.forEach(doc=>shifts.push({id: doc.id, ...doc.data()}));

    let shiftNo = null;
    if (!shifts.find(s=>s.shiftNo===1)) shiftNo=1;
    else if (shifts.find(s=>s.shiftNo===1 && s.status==='closed') && !shifts.find(s=>s.shiftNo===2)) shiftNo=2;
    else { alert("Cannot open shift."); return; }

    const existing = shifts.find(s=>s.shiftNo===shiftNo && s.status==='closed');
    if (existing) {
      if (!await requireSupervisor()) return;
      await db.collection("shifts").doc(existing.id).update({status:"open", user:currentUser, startTime:firebase.firestore.FieldValue.serverTimestamp(), endTime:null});
      await loadShifts();
      alert(`Shift ${shiftNo} reopened`);
      return;
    }

    await db.collection("shifts").add({shiftNo, status:"open", user:currentUser, startTime:firebase.firestore.FieldValue.serverTimestamp(), endTime:null, date:today});
    await loadShifts();
    alert(`Shift ${shiftNo} opened`);
  });

  closeBtn.addEventListener("click", async () => {
    if (!currentShift) return;
    await db.collection("shifts").doc(currentShift.id).update({status:"closed", endTime:firebase.firestore.FieldValue.serverTimestamp()});
    await loadShifts();
    alert(`Shift ${currentShift.shiftNo} closed`);
  });

  // Live update
  db.collection("shifts").where("date","==",today).orderBy("shiftNo").onSnapshot(snapshot => {
    const shifts = [];
    snapshot.forEach(doc=>shifts.push({id: doc.id, ...doc.data()}));
    renderShifts(shifts);
    currentShift = shifts.find(s=>s.status==='open')||null;
    updateShiftInfo(shifts);
  });

  loadShifts();
});
</script>
</body>
</html>
